<!-- ╔══════════════════════════════════════════════════════════════════════════════╗
     ║    7AWI SYSTEM - BOOKING ORDER MANAGER (Updated with Items, VAT, PDF)       ║
     ╚══════════════════════════════════════════════════════════════════════════════╝ -->

<!-- ==================== LIST VIEW ==================== -->
<div *ngIf="currentView() === 'list'" class="space-y-6">

  <!-- HEADER WITH ACTIONS -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h2 class="text-2xl font-black text-slate-800">Booking Orders</h2>
      <p class="text-slate-500 text-sm mt-1">Manage all booking orders and track profitability</p>
    </div>
    <div class="flex flex-wrap gap-3">
      <!-- Excel Export Button -->
      <button (click)="exportToExcel()"
              [disabled]="exporting() || filteredRevenues().length === 0"
              class="flex items-center gap-2 px-4 py-2.5 bg-emerald-600 text-white rounded-xl font-bold text-sm hover:bg-emerald-700 transition-all shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
        <span class="material-icons text-lg" [class.animate-spin]="exporting()">
          {{ exporting() ? 'sync' : 'download' }}
        </span>
        <span class="hidden sm:inline">{{ exporting() ? 'Exporting...' : 'Export Excel' }}</span>
        <span class="sm:hidden">Excel</span>
      </button>
      <!-- Add New Button -->
      <button (click)="openAddForm()"
              class="flex items-center gap-2 px-5 py-2.5 bg-hawy-blue text-white rounded-xl font-bold text-sm hover:bg-hawy-dark transition-all shadow-lg">
        <span class="material-icons text-lg">add</span>
        <span class="hidden sm:inline">Add Booking Order</span>
        <span class="sm:hidden">Add</span>
      </button>
    </div>
  </div>

  <!-- STATS CARDS - Responsive Grid -->
  <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4">
    <!-- Total Orders -->
    <div class="bg-white rounded-2xl p-4 sm:p-5 shadow-sm border border-slate-100">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-xl flex items-center justify-center">
          <span class="material-icons text-blue-600 text-lg sm:text-xl">receipt_long</span>
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-xs font-bold text-slate-400 uppercase tracking-wide truncate">Total</p>
          <p class="text-xl sm:text-2xl font-black text-slate-800">{{ totalRevenues() }}</p>
        </div>
      </div>
    </div>

    <!-- Estimated Revenue -->
    <div class="bg-white rounded-2xl p-4 sm:p-5 shadow-sm border border-slate-100">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
          <span class="material-icons text-emerald-600 text-lg sm:text-xl">trending_up</span>
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-xs font-bold text-slate-400 uppercase tracking-wide truncate">Estimated</p>
          <p class="text-lg sm:text-xl font-black text-emerald-600 truncate">{{ formatCurrency(totalEstimatedRevenue()) }}</p>
        </div>
      </div>
    </div>

    <!-- Actual Revenue -->
    <div class="bg-white rounded-2xl p-4 sm:p-5 shadow-sm border border-slate-100">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-blue-100 rounded-xl flex items-center justify-center">
          <span class="material-icons text-blue-600 text-lg sm:text-xl">payments</span>
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-xs font-bold text-slate-400 uppercase tracking-wide truncate">Actual</p>
          <p class="text-lg sm:text-xl font-black text-blue-600 truncate">{{ formatCurrency(totalActualRevenue()) }}</p>
        </div>
      </div>
    </div>

    <!-- Pending Approval -->
    <div class="bg-white rounded-2xl p-4 sm:p-5 shadow-sm border border-slate-100">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-amber-100 rounded-xl flex items-center justify-center">
          <span class="material-icons text-amber-600 text-lg sm:text-xl">pending_actions</span>
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-xs font-bold text-slate-400 uppercase tracking-wide truncate">Pending</p>
          <p class="text-xl sm:text-2xl font-black text-amber-600">{{ pendingApprovalCount() }}</p>
        </div>
      </div>
    </div>

    <!-- Multi-Retainer -->
    <div class="bg-white rounded-2xl p-4 sm:p-5 shadow-sm border border-slate-100 col-span-2 md:col-span-1">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-purple-100 rounded-xl flex items-center justify-center">
          <span class="material-icons text-purple-600 text-lg sm:text-xl">autorenew</span>
        </div>
        <div class="min-w-0 flex-1">
          <p class="text-xs font-bold text-slate-400 uppercase tracking-wide truncate">Retainer</p>
          <p class="text-xl sm:text-2xl font-black text-purple-600">{{ multiRetainerCount() }}</p>
        </div>
      </div>
    </div>
  </div>

  <!-- FILTERS - Responsive -->
  <div class="bg-white rounded-2xl p-4 sm:p-6 shadow-sm border border-slate-100">
    <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 sm:gap-4">
      <!-- Search -->
      <div class="col-span-2 sm:col-span-3 lg:col-span-2">
        <div class="relative">
          <span class="material-icons absolute left-3 top-1/2 -translate-y-1/2 text-slate-400">search</span>
          <input type="text" [ngModel]="searchText()" (ngModelChange)="searchText.set($event)"
                 placeholder="Search BO, campaign, client..."
                 class="w-full pl-10 pr-4 py-2.5 bg-slate-50 rounded-xl border-0 text-sm font-medium focus:ring-2 focus:ring-hawy-blue outline-none">
        </div>
      </div>

      <!-- Year -->
      <select [ngModel]="filterYear()" (ngModelChange)="filterYear.set($event)"
              class="w-full px-4 py-2.5 bg-slate-50 rounded-xl border-0 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
        <option [ngValue]="null">All Years</option>
        <option *ngFor="let year of yearsList()" [ngValue]="year">{{ year }}</option>
      </select>

      <!-- Month -->
      <select [ngModel]="filterMonth()" (ngModelChange)="filterMonth.set($event)"
              class="w-full px-4 py-2.5 bg-slate-50 rounded-xl border-0 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
        <option [ngValue]="null">All Months</option>
        <option *ngFor="let month of months" [ngValue]="month.value">{{ month.name }}</option>
      </select>

      <!-- Approval Status -->
      <select [ngModel]="filterApproval()" (ngModelChange)="filterApproval.set($event)"
              class="w-full px-4 py-2.5 bg-slate-50 rounded-xl border-0 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
        <option value="ALL">All Status</option>
        <option *ngFor="let status of approvalStatuses" [value]="status">{{ status }}</option>
      </select>

      <!-- Booking Type -->
      <select [ngModel]="filterType()" (ngModelChange)="filterType.set($event)"
              class="w-full px-4 py-2.5 bg-slate-50 rounded-xl border-0 text-sm font-bold text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
        <option value="ALL">All Types</option>
        <option *ngFor="let type of bookingOrderTypes" [value]="type">{{ type }}</option>
      </select>
    </div>
  </div>

  <!-- DATA TABLE - Responsive with horizontal scroll on mobile -->
  <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
    <div class="overflow-x-auto">
      <table class="w-full min-w-[900px]">
        <thead class="bg-gradient-to-r from-slate-800 to-slate-700">
          <tr>
            <th class="w-10 px-3 py-4 text-left text-[10px] font-black text-white uppercase tracking-wider"></th>
            <th class="px-4 py-4 text-left text-[10px] font-black text-white uppercase tracking-wider">BO / Campaign</th>
            <th class="px-4 py-4 text-left text-[10px] font-black text-white uppercase tracking-wider">Client</th>
            <th class="px-4 py-4 text-left text-[10px] font-black text-white uppercase tracking-wider hidden lg:table-cell">Dept</th>
            <th class="px-4 py-4 text-left text-[10px] font-black text-white uppercase tracking-wider">Type</th>
            <th class="px-4 py-4 text-right text-[10px] font-black text-white uppercase tracking-wider">Est. Revenue</th>
            <th class="px-4 py-4 text-right text-[10px] font-black text-white uppercase tracking-wider hidden md:table-cell">Total Cost</th>
            <th class="px-4 py-4 text-center text-[10px] font-black text-white uppercase tracking-wider">Margin</th>
            <th class="px-4 py-4 text-center text-[10px] font-black text-white uppercase tracking-wider">Status</th>
            <th class="px-4 py-4 text-center text-[10px] font-black text-white uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-100">
          <ng-container *ngFor="let revenue of filteredRevenues(); trackBy: trackByRevenue">
            <!-- Main Row -->
            <tr class="hover:bg-slate-50 transition-colors"
                [class.bg-amber-50]="revenue.approval_status === 'Pending'"
                [class.bg-red-50]="isProfitMarginLow(revenue) && revenue.approval_status !== 'Approved'">

              <!-- Expand Button -->
              <td class="px-3 py-4">
                <button *ngIf="revenue.booking_order_type === 'Multi Retainer'"
                        (click)="toggleRowExpansion(revenue.id!)"
                        class="w-7 h-7 rounded-lg bg-purple-100 hover:bg-purple-200 flex items-center justify-center transition-all">
                  <span class="material-icons text-purple-600 text-sm transition-transform"
                        [class.rotate-90]="isRowExpanded(revenue.id!)">chevron_right</span>
                </button>
              </td>

              <!-- BO / Campaign -->
              <td class="px-4 py-4">
                <div class="max-w-[200px]">
                  <p class="font-bold text-slate-800 text-sm truncate" [title]="revenue.bo_name">{{ revenue.bo_name || revenue.order_number || '-' }}</p>
                  <p class="text-xs text-slate-500 truncate" [title]="revenue.campaign_name">{{ revenue.campaign_name || '-' }}</p>
                </div>
              </td>

              <!-- Client -->
              <td class="px-4 py-4">
                <span class="font-medium text-slate-700 text-sm">{{ dataService.getClientName(revenue.client_id) }}</span>
              </td>

              <!-- Department -->
              <td class="px-4 py-4 hidden lg:table-cell">
                <span class="text-sm text-slate-600">{{ dataService.getProductName(revenue.product_id) }}</span>
              </td>

              <!-- Type -->
              <td class="px-4 py-4">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-bold"
                      [class.bg-blue-100]="revenue.booking_order_type === 'One Time'"
                      [class.text-blue-700]="revenue.booking_order_type === 'One Time'"
                      [class.bg-purple-100]="revenue.booking_order_type === 'Multi Retainer'"
                      [class.text-purple-700]="revenue.booking_order_type === 'Multi Retainer'">
                  <span class="material-icons text-xs">{{ revenue.booking_order_type === 'Multi Retainer' ? 'autorenew' : 'schedule' }}</span>
                  <span class="hidden sm:inline">{{ revenue.booking_order_type }}</span>
                </span>
              </td>

              <!-- Est. Revenue -->
              <td class="px-4 py-4 text-right">
                <span class="font-bold text-emerald-600">{{ formatCurrency(revenue.estimated_revenue || revenue.gross_amount) }}</span>
              </td>

              <!-- Total Cost -->
              <td class="px-4 py-4 text-right hidden md:table-cell">
                <span class="font-medium text-rose-600">{{ formatCurrency(calculateTotalCost(revenue)) }}</span>
              </td>

              <!-- Margin -->
              <td class="px-4 py-4 text-center">
                <span class="inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-black"
                      [class.bg-emerald-100]="calculateProfitMargin(revenue) >= 30"
                      [class.text-emerald-700]="calculateProfitMargin(revenue) >= 30"
                      [class.bg-red-100]="calculateProfitMargin(revenue) < 30"
                      [class.text-red-700]="calculateProfitMargin(revenue) < 30">
                  <span class="material-icons text-xs" *ngIf="calculateProfitMargin(revenue) < 30">warning</span>
                  {{ calculateProfitMargin(revenue) | number:'1.1-1' }}%
                </span>
              </td>

              <!-- Status -->
              <td class="px-4 py-4 text-center">
                <span class="px-2 py-1 rounded-lg text-xs font-bold" [ngClass]="getApprovalStatusClass(revenue.approval_status)">
                  {{ revenue.approval_status || 'N/A' }}
                </span>
              </td>

              <!-- Actions -->
              <td class="px-4 py-4">
                <div class="flex items-center justify-center gap-1">
                  <button (click)="editRevenue(revenue)"
                          class="w-8 h-8 rounded-lg bg-blue-50 hover:bg-blue-100 flex items-center justify-center transition-all"
                          title="Edit">
                    <span class="material-icons text-blue-600 text-sm">edit</span>
                  </button>
                  <button *ngIf="canApprove() && revenue.approval_status === 'Pending'"
                          (click)="openApprovalModal(revenue)"
                          class="w-8 h-8 rounded-lg bg-emerald-50 hover:bg-emerald-100 flex items-center justify-center transition-all"
                          title="Approve">
                    <span class="material-icons text-emerald-600 text-sm">check_circle</span>
                  </button>
                  <button (click)="confirmDelete(revenue)"
                          class="w-8 h-8 rounded-lg bg-rose-50 hover:bg-rose-100 flex items-center justify-center transition-all"
                          title="Delete">
                    <span class="material-icons text-rose-600 text-sm">delete</span>
                  </button>
                </div>
              </td>
            </tr>

            <!-- Expanded Row for Monthly Distribution -->
            <tr *ngIf="isRowExpanded(revenue.id!) && revenue.booking_order_type === 'Multi Retainer'"
                class="bg-purple-50/50">
              <td colspan="10" class="px-6 py-4">
                <div class="bg-white rounded-xl border border-purple-100 p-4 overflow-x-auto">
                  <h4 class="font-bold text-purple-800 text-sm mb-3 flex items-center gap-2">
                    <span class="material-icons text-sm">calendar_month</span>
                    Monthly Distribution
                  </h4>
                  <table class="w-full min-w-[500px]">
                    <thead>
                      <tr class="bg-purple-100/50">
                        <th class="px-3 py-2 text-left text-xs font-bold text-purple-800">Month</th>
                        <th class="px-3 py-2 text-right text-xs font-bold text-purple-800">Estimated</th>
                        <th class="px-3 py-2 text-right text-xs font-bold text-purple-800">Actual</th>
                        <th class="px-3 py-2 text-center text-xs font-bold text-purple-800">Variance</th>
                      </tr>
                    </thead>
                    <tbody class="divide-y divide-purple-100">
                      <tr *ngFor="let monthly of getMonthlyDataForRevenue(revenue.id!)" class="hover:bg-purple-50">
                        <td class="px-3 py-2 text-sm font-medium text-slate-700">
                          {{ getMonthName(monthly.month) }} {{ monthly.year }}
                        </td>
                        <td class="px-3 py-2 text-right text-sm font-bold text-emerald-600">
                          {{ formatCurrency(monthly.estimated_revenue) }}
                        </td>
                        <td class="px-3 py-2 text-right">
                          <input type="number" [value]="monthly.actual_revenue"
                                 (blur)="updateMonthlyActual(monthly, $any($event.target).valueAsNumber)"
                                 class="w-24 px-2 py-1 bg-white border border-purple-200 rounded-lg text-sm text-right font-bold text-blue-600 focus:ring-2 focus:ring-purple-400 outline-none">
                        </td>
                        <td class="px-3 py-2 text-center">
                          <span class="text-xs font-bold"
                                [class.text-emerald-600]="monthly.actual_revenue >= monthly.estimated_revenue"
                                [class.text-red-600]="monthly.actual_revenue < monthly.estimated_revenue">
                            {{ monthly.actual_revenue - monthly.estimated_revenue >= 0 ? '+' : '' }}{{ formatCurrency(monthly.actual_revenue - monthly.estimated_revenue) }}
                          </span>
                        </td>
                      </tr>
                      <tr *ngIf="getMonthlyDataForRevenue(revenue.id!).length === 0">
                        <td colspan="4" class="px-3 py-4 text-center text-slate-400 text-sm">
                          No monthly data available
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </td>
            </tr>
          </ng-container>

          <!-- Empty State -->
          <tr *ngIf="filteredRevenues().length === 0">
            <td colspan="10" class="px-6 py-12 text-center">
              <span class="material-icons text-5xl text-slate-200 mb-3">inbox</span>
              <p class="text-slate-400 font-medium">No booking orders found</p>
              <p class="text-slate-300 text-sm">Try adjusting your filters or add a new order</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- ==================== FORM VIEW ==================== -->
<div *ngIf="currentView() === 'form'" class="space-y-6">

  <!-- FORM HEADER -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div class="flex items-center gap-3">
      <button (click)="goBackToList()"
              class="w-10 h-10 rounded-xl bg-slate-100 hover:bg-slate-200 flex items-center justify-center transition-all">
        <span class="material-icons text-slate-600">arrow_back</span>
      </button>
      <div>
        <h2 class="text-xl sm:text-2xl font-black text-slate-800">
          {{ isEditMode ? 'Edit Booking Order' : 'New Booking Order' }}
        </h2>
        <p class="text-slate-500 text-sm mt-0.5">Fill in the details below</p>
      </div>
    </div>
    <div class="flex gap-3">
      <!-- PDF Export -->
      <button (click)="exportToPDF()" [disabled]="generatingPdf()"
              class="flex items-center gap-2 px-4 py-2.5 bg-rose-600 text-white rounded-xl font-bold text-sm hover:bg-rose-700 disabled:opacity-50">
        <span class="material-icons text-lg" [class.animate-spin]="generatingPdf()">{{ generatingPdf() ? 'sync' : 'picture_as_pdf' }}</span>
        <span class="hidden sm:inline">Print Quotation</span>
      </button>
      <!-- Save -->
      <button (click)="save()" [disabled]="saving()"
              class="w-full sm:w-auto flex items-center justify-center gap-2 px-6 py-3 bg-hawy-blue text-white rounded-xl font-bold text-sm hover:bg-hawy-dark transition-all shadow-lg disabled:opacity-50">
        <span class="material-icons text-lg" [class.animate-spin]="saving()">{{ saving() ? 'sync' : 'save' }}</span>
        {{ saving() ? 'Saving...' : 'Save Booking Order' }}
      </button>
    </div>
  </div>

  <!-- FORM GRID - Responsive -->
  <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">

    <!-- ==================== MAIN COLUMN (2/3) ==================== -->
    <div class="xl:col-span-2 space-y-6">

      <!-- PROJECT INFO SECTION -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="bg-gradient-to-r from-slate-700 to-slate-600 px-5 py-3">
          <h3 class="text-white font-bold flex items-center gap-2">
            <span class="material-icons text-lg">info</span>
            Project Information
          </h3>
        </div>
        <div class="p-4 sm:p-6 space-y-4">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <!-- Campaign Name -->
            <div class="sm:col-span-2">
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Campaign Name *</label>
              <input type="text" [(ngModel)]="currentItem.campaign_name" required
                     placeholder="e.g., Ramadan Event Campaign"
                     class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
            </div>

            <!-- BO Name (Auto-generated) -->
            <div class="sm:col-span-2">
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">BO Name (Auto-generated)</label>
              <div class="flex gap-2">
                <input type="text" [(ngModel)]="currentItem.bo_name" readonly
                       class="flex-1 px-4 py-3 bg-slate-100 rounded-xl border-0 font-mono text-sm text-slate-600">
                <button (click)="generateBoName()" type="button"
                        class="px-4 py-3 bg-hawy-blue text-white rounded-xl hover:bg-hawy-dark transition-all"
                        title="Regenerate BO Name">
                  <span class="material-icons">refresh</span>
                </button>
              </div>
            </div>

            <!-- Booking Order Type -->
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Booking Order Type</label>
              <select [(ngModel)]="currentItem.booking_order_type" (ngModelChange)="onBookingOrderTypeChange($event)"
                      class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
                <option *ngFor="let type of bookingOrderTypes" [value]="type">{{ type }}</option>
              </select>
            </div>

            <!-- Project Type -->
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Project Type</label>
              <select [(ngModel)]="currentItem.project_type"
                      class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
                <option *ngFor="let type of projectTypes" [value]="type">{{ type }}</option>
              </select>
            </div>

            <!-- Client -->
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Client</label>
              <select [(ngModel)]="currentItem.client_id"
                      class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
                <option [ngValue]="undefined">Select Client</option>
                <option *ngFor="let client of sortedClients()" [ngValue]="client.client_id">{{ client.client_name }}</option>
              </select>
            </div>

            <!-- Department -->
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Department</label>
              <select [(ngModel)]="currentItem.product_id"
                      class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
                <option *ngFor="let prod of sortedProducts()" [ngValue]="prod.product_id">{{ prod.product_name }}</option>
              </select>
            </div>

            <!-- Owner -->
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Owner</label>
              <select [(ngModel)]="currentItem.owner_id"
                      class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
                <option [ngValue]="undefined">Select Owner</option>
                <option *ngFor="let emp of sortedEmployees()" [ngValue]="emp.employee_id">{{ emp.name }}</option>
              </select>
            </div>

            <!-- Country -->
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Country</label>
              <select [(ngModel)]="currentItem.country"
                      class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
                <option *ngFor="let country of countries" [value]="country">{{ country }}</option>
              </select>
            </div>

            <!-- Status -->
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Status</label>
              <select [(ngModel)]="currentItem.approval_status"
                      class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none">
                <option *ngFor="let status of orderStatuses" [value]="status.value">{{ status.label }}</option>
              </select>
            </div>

            <!-- Description -->
            <div class="sm:col-span-2">
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Description</label>
              <textarea [(ngModel)]="currentItem.description" rows="2"
                        placeholder="Brief project description..."
                        class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-hawy-blue outline-none resize-none"></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ ITEMS TABLE SECTION -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="bg-gradient-to-r from-cyan-600 to-cyan-500 px-5 py-3 flex justify-between items-center">
          <h3 class="text-white font-bold flex items-center gap-2">
            <span class="material-icons text-lg">list_alt</span>Items / Services
          </h3>
          <button (click)="addItem()" type="button" class="flex items-center gap-1 px-3 py-1.5 bg-white/20 hover:bg-white/30 text-white rounded-lg text-sm font-bold">
            <span class="material-icons text-sm">add</span>Add Item
          </button>
        </div>
        <div class="p-4 sm:p-6">
          <div class="overflow-x-auto">
            <table class="w-full min-w-[600px]">
              <thead class="bg-slate-50">
                <tr>
                  <th class="px-3 py-2 text-left text-[10px] font-black text-slate-500 uppercase">#</th>
                  <th class="px-3 py-2 text-left text-[10px] font-black text-slate-500 uppercase">Item Name</th>
                  <th class="px-3 py-2 text-center text-[10px] font-black text-slate-500 uppercase w-20">Qty</th>
                  <th class="px-3 py-2 text-right text-[10px] font-black text-slate-500 uppercase w-28">Unit Price</th>
                  <th class="px-3 py-2 text-right text-[10px] font-black text-slate-500 uppercase w-24">Discount</th>
                  <th class="px-3 py-2 text-right text-[10px] font-black text-slate-500 uppercase w-28">Net</th>
                  <th class="px-3 py-2 w-12"></th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                <tr *ngFor="let item of orderItems(); let i = index; trackBy: trackByItem" class="hover:bg-slate-50">
                  <td class="px-3 py-2 text-sm font-bold text-slate-400">{{ item.item_order }}</td>
                  <td class="px-3 py-2">
                    <input type="text" [(ngModel)]="item.item_name" placeholder="Service or product name"
                           class="w-full px-2 py-1.5 bg-white border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-cyan-400 outline-none">
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" [(ngModel)]="item.quantity" (ngModelChange)="updateItemNet(item)" min="1"
                           class="w-full px-2 py-1.5 bg-white border border-slate-200 rounded-lg text-sm text-center focus:ring-2 focus:ring-cyan-400 outline-none">
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" [(ngModel)]="item.unit_price" (ngModelChange)="updateItemNet(item)" min="0"
                           class="w-full px-2 py-1.5 bg-white border border-slate-200 rounded-lg text-sm text-right focus:ring-2 focus:ring-cyan-400 outline-none">
                  </td>
                  <td class="px-3 py-2">
                    <input type="number" [(ngModel)]="item.discount" (ngModelChange)="updateItemNet(item)" min="0"
                           class="w-full px-2 py-1.5 bg-white border border-slate-200 rounded-lg text-sm text-right focus:ring-2 focus:ring-cyan-400 outline-none">
                  </td>
                  <td class="px-3 py-2 text-right font-bold text-cyan-700">{{ formatCurrency(item.net_amount) }}</td>
                  <td class="px-3 py-2 text-center">
                    <button (click)="removeItem(i)" type="button" class="w-7 h-7 rounded-lg bg-red-50 hover:bg-red-100 flex items-center justify-center">
                      <span class="material-icons text-red-500 text-sm">close</span>
                    </button>
                  </td>
                </tr>
                <tr *ngIf="orderItems().length === 0">
                  <td colspan="7" class="px-3 py-8 text-center text-slate-400">
                    <span class="material-icons text-3xl text-slate-200 mb-2">inventory_2</span>
                    <p class="text-sm">No items added yet. Click "Add Item" to start.</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Totals -->
          <div class="mt-4 pt-4 border-t border-slate-100 space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm font-bold text-slate-600">Subtotal:</span>
              <span class="text-lg font-black text-slate-800">{{ formatCurrency(itemsSubtotal()) }}</span>
            </div>
            <!-- VAT Toggle -->
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 p-3 bg-slate-50 rounded-xl">
              <div class="flex items-center gap-3">
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" [(ngModel)]="currentItem.vat_enabled" (ngModelChange)="onVatChange()" class="sr-only peer">
                  <div class="w-11 h-6 bg-slate-200 peer-focus:ring-4 peer-focus:ring-cyan-300 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-cyan-600"></div>
                </label>
                <span class="text-sm font-bold text-slate-600">Enable VAT</span>
              </div>
              <div class="flex items-center gap-2" *ngIf="currentItem.vat_enabled">
                <input type="number" [(ngModel)]="currentItem.vat_percentage" (ngModelChange)="onVatChange()" min="0" max="100" step="0.5"
                       class="w-20 px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-sm text-center font-bold focus:ring-2 focus:ring-cyan-400 outline-none">
                <span class="text-sm text-slate-500">%</span>
                <span class="text-sm font-bold text-cyan-600 ml-4">{{ formatCurrency(vatAmount()) }}</span>
              </div>
            </div>
            <!-- Grand Total -->
            <div class="flex justify-between items-center p-3 bg-gradient-to-r from-cyan-50 to-emerald-50 rounded-xl border border-cyan-100">
              <span class="text-sm font-black text-cyan-800">Grand Total:</span>
              <span class="text-2xl font-black text-cyan-700">{{ formatCurrency(grandTotal()) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- DATES SECTION -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="bg-gradient-to-r from-amber-600 to-amber-500 px-5 py-3">
          <h3 class="text-white font-bold flex items-center gap-2">
            <span class="material-icons text-lg">event</span>
            Project Dates
          </h3>
        </div>
        <div class="p-4 sm:p-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- BO Submission Date -->
            <div>
              <label class="block text-[10px] font-black text-amber-600 uppercase tracking-wider mb-1.5">
                <span class="material-icons text-xs align-middle mr-1">send</span>Submission Date
              </label>
              <input type="text" id="bo_submission_date" [(ngModel)]="currentItem.bo_submission_date"
                     placeholder="Select date"
                     class="w-full px-4 py-3 bg-amber-50 rounded-xl border border-amber-200 font-medium text-slate-700 focus:ring-2 focus:ring-amber-400 outline-none">
            </div>

            <!-- Start Date -->
            <div>
              <label class="block text-[10px] font-black text-emerald-600 uppercase tracking-wider mb-1.5">
                <span class="material-icons text-xs align-middle mr-1">play_arrow</span>Start Date
              </label>
              <input type="text" id="start_date" [(ngModel)]="currentItem.start_date"
                     placeholder="Select date"
                     class="w-full px-4 py-3 bg-emerald-50 rounded-xl border border-emerald-200 font-medium text-slate-700 focus:ring-2 focus:ring-emerald-400 outline-none">
            </div>

            <!-- End Date -->
            <div>
              <label class="block text-[10px] font-black text-red-600 uppercase tracking-wider mb-1.5">
                <span class="material-icons text-xs align-middle mr-1">stop</span>End Date
              </label>
              <input type="text" id="end_date" [(ngModel)]="currentItem.end_date"
                     placeholder="Select date"
                     class="w-full px-4 py-3 bg-red-50 rounded-xl border border-red-200 font-medium text-slate-700 focus:ring-2 focus:ring-red-400 outline-none">
            </div>

            <!-- Payment Date -->
            <div>
              <label class="block text-[10px] font-black text-blue-600 uppercase tracking-wider mb-1.5">
                <span class="material-icons text-xs align-middle mr-1">payments</span>Expected Payment
              </label>
              <input type="text" id="expected_payment_date" [(ngModel)]="currentItem.expected_payment_date"
                     placeholder="Select date"
                     class="w-full px-4 py-3 bg-blue-50 rounded-xl border border-blue-200 font-medium text-slate-700 focus:ring-2 focus:ring-blue-400 outline-none">
            </div>
          </div>

          <!-- Multi-Retainer Info Banner -->
          <div *ngIf="currentItem.payment_type === 'multi_retainer' && currentItem.start_date && currentItem.end_date"
               class="mt-4 p-4 bg-purple-50 border border-purple-200 rounded-xl">
            <div class="flex flex-col sm:flex-row sm:items-center gap-3">
              <div class="flex items-center gap-2">
                <span class="material-icons text-purple-600">autorenew</span>
                <span class="font-bold text-purple-800">Multi-Retainer:</span>
              </div>
              <div class="flex flex-wrap items-center gap-4 text-sm">
                <span class="text-purple-700"><strong>{{ getMonthsCount() }}</strong> months</span>
                <span class="text-purple-700">{{ formatCurrency((currentItem.estimated_revenue || 0) / getMonthsCount()) }}/month</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ✅ PAYMENT TERMS SECTION -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="bg-gradient-to-r from-indigo-600 to-indigo-500 px-5 py-3">
          <h3 class="text-white font-bold flex items-center gap-2">
            <span class="material-icons text-lg">account_balance_wallet</span>
            Payment Terms
          </h3>
        </div>
        <div class="p-4 sm:p-6">
          <!-- Payment Type Selection - Card Style -->
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-4">
            <button *ngFor="let pt of paymentTypes" type="button" (click)="setPaymentType(pt.value)"
                    [class.ring-2]="currentItem.payment_type === pt.value"
                    [class.ring-indigo-500]="currentItem.payment_type === pt.value"
                    [class.bg-indigo-50]="currentItem.payment_type === pt.value"
                    class="flex flex-col items-center gap-2 p-4 bg-slate-50 rounded-xl border border-slate-200 hover:border-indigo-300 cursor-pointer transition-all">
              <span class="material-icons text-2xl" [class.text-indigo-600]="currentItem.payment_type === pt.value" [class.text-slate-400]="currentItem.payment_type !== pt.value">{{ pt.icon }}</span>
              <span class="text-xs font-bold" [class.text-indigo-700]="currentItem.payment_type === pt.value" [class.text-slate-600]="currentItem.payment_type !== pt.value">{{ pt.label }}</span>
              <span class="text-[10px] text-slate-400 text-center">{{ pt.description }}</span>
            </button>
          </div>

          <!-- One Time Options -->
          <div *ngIf="currentItem.payment_type === 'one_time'" class="p-4 bg-indigo-50 rounded-xl border border-indigo-200">
            <label class="block text-[10px] font-black text-indigo-600 uppercase mb-2">Payment Timing</label>
            <div class="grid grid-cols-2 gap-3">
              <button *ngFor="let term of oneTimePaymentTerms" type="button" (click)="currentItem.payment_terms = term.value"
                      [class.ring-2]="currentItem.payment_terms === term.value"
                      [class.ring-indigo-500]="currentItem.payment_terms === term.value"
                      [class.bg-white]="currentItem.payment_terms === term.value"
                      class="px-4 py-3 bg-indigo-100/50 rounded-lg font-bold text-sm transition-all">
                {{ term.label }}
              </button>
            </div>
          </div>

          <!-- Multiple Payment (Milestones) -->
          <div *ngIf="currentItem.payment_type === 'multiple'" class="p-4 bg-indigo-50 rounded-xl border border-indigo-200">
            <div class="flex justify-between items-center mb-3">
              <label class="text-[10px] font-black text-indigo-600 uppercase">Payment Milestones</label>
              <button (click)="addMilestone()" type="button" class="flex items-center gap-1 px-2 py-1 bg-indigo-600 text-white rounded-lg text-xs font-bold">
                <span class="material-icons text-xs">add</span>Add
              </button>
            </div>
            <div class="space-y-2">
              <div *ngFor="let milestone of paymentMilestones(); let i = index; trackBy: trackByMilestone" class="flex items-center gap-3 p-3 bg-white rounded-lg">
                <input type="text" [(ngModel)]="milestone.milestone_name" placeholder="Milestone name"
                       class="flex-1 px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-medium focus:ring-2 focus:ring-indigo-400 outline-none">
                <div class="flex items-center gap-1">
                  <input type="number" [(ngModel)]="milestone.percentage" (ngModelChange)="updateMilestoneAmounts()" min="1" max="100"
                         class="w-16 px-2 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm text-center font-bold focus:ring-2 focus:ring-indigo-400 outline-none">
                  <span class="text-sm text-slate-500">%</span>
                </div>
                <span class="text-sm font-bold text-indigo-600 w-24 text-right">{{ formatCurrency(milestone.amount) }}</span>
                <button (click)="removeMilestone(i)" type="button" class="w-7 h-7 rounded-lg bg-red-50 hover:bg-red-100 flex items-center justify-center">
                  <span class="material-icons text-red-500 text-sm">close</span>
                </button>
              </div>
            </div>
            <!-- Validation -->
            <div class="mt-3 flex justify-between items-center p-2 rounded-lg" [class.bg-emerald-100]="milestonesValid()" [class.bg-red-100]="!milestonesValid()">
              <span class="text-xs font-bold" [class.text-emerald-700]="milestonesValid()" [class.text-red-700]="!milestonesValid()">
                Total: {{ milestonesTotal() }}%
              </span>
              <span *ngIf="!milestonesValid()" class="text-xs text-red-600 flex items-center gap-1">
                <span class="material-icons text-xs">warning</span>Must equal 100%
              </span>
              <span *ngIf="milestonesValid()" class="text-xs text-emerald-600 flex items-center gap-1">
                <span class="material-icons text-xs">check_circle</span>Valid
              </span>
            </div>
          </div>

          <!-- Multi Retainer -->
          <div *ngIf="currentItem.payment_type === 'multi_retainer'" class="p-4 bg-indigo-50 rounded-xl border border-indigo-200">
            <div class="flex justify-between items-center mb-3">
              <label class="text-[10px] font-black text-indigo-600 uppercase">Retainer Period</label>
              <button *ngIf="currentItem.start_date && currentItem.end_date" type="button"
                      (click)="syncRetainerDatesFromProject()"
                      class="text-xs font-bold text-indigo-600 hover:text-indigo-800 flex items-center gap-1 px-2 py-1 bg-white rounded-lg border border-indigo-200 hover:bg-indigo-100 transition-all">
                <span class="material-icons text-xs">sync</span>Sync from Project Dates
              </button>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-bold text-indigo-700 mb-1.5">Start Date</label>
                <input type="text" id="payment_retainer_start" [(ngModel)]="currentItem.payment_retainer_start"
                       [placeholder]="currentItem.start_date || 'Select start'"
                       class="w-full px-4 py-3 bg-white rounded-xl border border-indigo-200 font-medium text-slate-700 focus:ring-2 focus:ring-indigo-400 outline-none">
              </div>
              <div>
                <label class="block text-xs font-bold text-indigo-700 mb-1.5">End Date</label>
                <input type="text" id="payment_retainer_end" [(ngModel)]="currentItem.payment_retainer_end"
                       [placeholder]="currentItem.end_date || 'Select end'"
                       class="w-full px-4 py-3 bg-white rounded-xl border border-indigo-200 font-medium text-slate-700 focus:ring-2 focus:ring-indigo-400 outline-none">
              </div>
            </div>
            <!-- Monthly Distribution Preview -->
            <div *ngIf="getMonthsCount() > 0" class="mt-3 p-3 bg-purple-100 rounded-lg">
              <div class="flex items-center justify-between">
                <span class="text-sm font-bold text-purple-800">
                  <span class="material-icons text-sm align-middle mr-1">calendar_month</span>
                  {{ getMonthsCount() }} months
                </span>
                <span class="text-sm font-bold text-purple-800">
                  {{ formatCurrency((currentItem.estimated_revenue || 0) / getMonthsCount()) }} / month
                </span>
              </div>
            </div>
          </div>

          <!-- Payment Terms Summary -->
          <div class="mt-4 p-3 bg-slate-50 rounded-xl flex items-center gap-3">
            <span class="material-icons text-slate-400">info</span>
            <p class="text-sm text-slate-600">
              <strong>Selected:</strong> {{ getPaymentTermsDisplay(currentItem) }}
            </p>
          </div>
        </div>
      </div>

      <!-- REVENUE SECTION -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="bg-gradient-to-r from-emerald-600 to-emerald-500 px-5 py-3">
          <h3 class="text-white font-bold flex items-center gap-2">
            <span class="material-icons text-lg">monetization_on</span>
            Revenue
          </h3>
        </div>
        <div class="p-4 sm:p-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <!-- Estimated Revenue -->
            <div>
              <label class="block text-[10px] font-black text-emerald-600 uppercase tracking-wider mb-1.5">Estimated Revenue ($)</label>
              <input type="number" [(ngModel)]="currentItem.estimated_revenue" min="0" step="100"
                     class="w-full px-4 py-3 bg-emerald-50 rounded-xl border border-emerald-200 font-bold text-emerald-700 text-lg focus:ring-2 focus:ring-emerald-400 outline-none">
            </div>

            <!-- Actual Revenue -->
            <div>
              <label class="block text-[10px] font-black text-blue-600 uppercase tracking-wider mb-1.5">
                Actual Revenue ($)
                <span *ngIf="!isActualRevenueEnabled()" class="text-red-500 ml-1">(Enabled when Completed)</span>
              </label>
              <input type="number" [(ngModel)]="currentItem.gross_amount" min="0" step="100"
                     [disabled]="!isActualRevenueEnabled()"
                     class="w-full px-4 py-3 rounded-xl border font-bold text-lg focus:ring-2 outline-none"
                     [class.bg-blue-50]="isActualRevenueEnabled()"
                     [class.border-blue-200]="isActualRevenueEnabled()"
                     [class.text-blue-700]="isActualRevenueEnabled()"
                     [class.bg-slate-100]="!isActualRevenueEnabled()"
                     [class.border-slate-200]="!isActualRevenueEnabled()"
                     [class.text-slate-400]="!isActualRevenueEnabled()"
                     [class.cursor-not-allowed]="!isActualRevenueEnabled()">
            </div>
          </div>
        </div>
      </div>

      <!-- DIRECT COSTS SECTION -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="bg-gradient-to-r from-rose-600 to-rose-500 px-5 py-3">
          <h3 class="text-white font-bold flex items-center gap-2">
            <span class="material-icons text-lg">receipt</span>
            Direct Costs
          </h3>
        </div>
        <div class="p-4 sm:p-6">
          <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-3 sm:gap-4">
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Labor ($)</label>
              <input type="number" [(ngModel)]="currentItem.direct_cost_labor" min="0"
                     class="w-full px-3 py-2.5 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-rose-400 outline-none">
            </div>
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Material ($)</label>
              <input type="number" [(ngModel)]="currentItem.direct_cost_material" min="0"
                     class="w-full px-3 py-2.5 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-rose-400 outline-none">
            </div>
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Equipment ($)</label>
              <input type="number" [(ngModel)]="currentItem.direct_cost_equipment" min="0"
                     class="w-full px-3 py-2.5 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-rose-400 outline-none">
            </div>
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Tools ($)</label>
              <input type="number" [(ngModel)]="currentItem.direct_cost_tools" min="0"
                     class="w-full px-3 py-2.5 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-rose-400 outline-none">
            </div>
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Others ($)</label>
              <input type="number" [(ngModel)]="currentItem.direct_cost_other" min="0"
                     class="w-full px-3 py-2.5 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-rose-400 outline-none">
            </div>
          </div>
          <div class="mt-4 pt-4 border-t border-slate-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <span class="text-sm font-bold text-slate-600">Total Direct Cost:</span>
            <span class="text-xl font-black text-rose-600">{{ formatCurrency(calculateTotalDirectCost(currentItem)) }}</span>
          </div>
        </div>
      </div>

      <!-- ONE TIME COSTS SECTION -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="bg-gradient-to-r from-purple-600 to-purple-500 px-5 py-3">
          <h3 class="text-white font-bold flex items-center gap-2">
            <span class="material-icons text-lg">shopping_bag</span>
            One Time Costs
          </h3>
        </div>
        <div class="p-4 sm:p-6">
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Marketing ($)</label>
              <input type="number" [(ngModel)]="currentItem.one_time_marketing" min="0"
                     class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-purple-400 outline-none">
            </div>
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Consultation ($)</label>
              <input type="number" [(ngModel)]="currentItem.one_time_consultation" min="0"
                     class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-purple-400 outline-none">
            </div>
            <div>
              <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-1.5">Miscellaneous ($)</label>
              <input type="number" [(ngModel)]="currentItem.one_time_misc" min="0"
                     class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-purple-400 outline-none">
            </div>
          </div>
          <div class="mt-4 pt-4 border-t border-slate-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <span class="text-sm font-bold text-slate-600">Total One Time Cost:</span>
            <span class="text-xl font-black text-purple-600">{{ formatCurrency(calculateTotalOneTimeCost(currentItem)) }}</span>
          </div>
        </div>
      </div>

      <!-- COMMENTS SECTION -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
        <div class="bg-gradient-to-r from-slate-600 to-slate-500 px-5 py-3">
          <h3 class="text-white font-bold flex items-center gap-2">
            <span class="material-icons text-lg">comment</span>
            Comments
          </h3>
        </div>
        <div class="p-4 sm:p-6">
          <textarea [(ngModel)]="currentItem.comments" rows="4"
                    placeholder="Add any additional notes or comments..."
                    class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-slate-400 outline-none resize-none"></textarea>
        </div>
      </div>

    </div>

    <!-- ==================== SIDEBAR (1/3) ==================== -->
    <div class="space-y-6">

      <!-- PROFITABILITY ANALYSIS CARD -->
      <div class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden sticky top-6">
        <div class="px-5 py-4"
             [class.bg-gradient-to-r]="true"
             [class.from-emerald-600]="calculateProfitMargin(currentItem) >= 30"
             [class.to-emerald-500]="calculateProfitMargin(currentItem) >= 30"
             [class.from-amber-600]="calculateProfitMargin(currentItem) >= 25 && calculateProfitMargin(currentItem) < 30"
             [class.to-amber-500]="calculateProfitMargin(currentItem) >= 25 && calculateProfitMargin(currentItem) < 30"
             [class.from-red-600]="calculateProfitMargin(currentItem) < 25"
             [class.to-red-500]="calculateProfitMargin(currentItem) < 25">
          <h3 class="text-white font-bold flex items-center gap-2">
            <span class="material-icons text-lg">analytics</span>
            Profitability Analysis
          </h3>
        </div>
        <div class="p-5">
          <!-- Profit Margin Display -->
          <div class="text-center mb-6">
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Actual Profit Margin</p>
            <div class="flex items-center justify-center gap-2">
              <span *ngIf="calculateProfitMargin(currentItem) < 30" class="material-icons text-3xl animate-pulse"
                    [class.text-red-500]="calculateProfitMargin(currentItem) < 25"
                    [class.text-amber-500]="calculateProfitMargin(currentItem) >= 25">warning</span>
              <span class="text-4xl sm:text-5xl font-black"
                    [class.text-emerald-600]="calculateProfitMargin(currentItem) >= 30"
                    [class.text-amber-600]="calculateProfitMargin(currentItem) >= 25 && calculateProfitMargin(currentItem) < 30"
                    [class.text-red-600]="calculateProfitMargin(currentItem) < 25">
                {{ calculateProfitMargin(currentItem) | number:'1.1-1' }}%
              </span>
            </div>
            <p *ngIf="calculateProfitMargin(currentItem) < 25" class="mt-2 text-xs font-bold text-red-500 bg-red-50 rounded-lg py-1.5 px-3 inline-block">
              🔴 Critical - Requires Admin Approval
            </p>
            <p *ngIf="calculateProfitMargin(currentItem) >= 25 && calculateProfitMargin(currentItem) < 30" class="mt-2 text-xs font-bold text-amber-600 bg-amber-50 rounded-lg py-1.5 px-3 inline-block">
              🟠 Below Target - Requires Approval
            </p>
            <p *ngIf="calculateProfitMargin(currentItem) >= 30" class="mt-2 text-xs font-bold text-emerald-600 bg-emerald-50 rounded-lg py-1.5 px-3 inline-block">
              🟢 Healthy Margin
            </p>
          </div>

          <!-- Summary -->
          <div class="space-y-3 mb-6 p-4 bg-slate-50 rounded-xl">
            <div class="flex justify-between items-center">
              <span class="text-sm text-slate-600">Total Revenue</span>
              <span class="font-bold text-emerald-600">{{ formatCurrency(currentItem.estimated_revenue || currentItem.gross_amount) }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-slate-600">Total Cost</span>
              <span class="font-bold text-rose-600">-{{ formatCurrency(calculateTotalCost(currentItem)) }}</span>
            </div>
            <div class="pt-3 border-t border-slate-200 flex justify-between items-center">
              <span class="text-sm font-bold text-slate-700">Net Profit</span>
              <span class="text-lg font-black"
                    [class.text-emerald-600]="calculateNetProfit(currentItem) >= 0"
                    [class.text-red-600]="calculateNetProfit(currentItem) < 0">
                {{ formatCurrency(calculateNetProfit(currentItem)) }}
              </span>
            </div>
          </div>

          <!-- Margin Thresholds Table (Editable) -->
          <div>
            <p class="text-xs font-bold text-slate-500 uppercase tracking-wider mb-3">Required Revenue for Target Margins</p>
            <div class="overflow-hidden rounded-xl border border-slate-200">
              <table class="w-full text-sm">
                <thead class="bg-slate-100">
                  <tr>
                    <th class="px-3 py-2 text-left font-bold text-slate-600">Margin %</th>
                    <th class="px-3 py-2 text-right font-bold text-slate-600">Required</th>
                  </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                  <tr class="bg-red-50">
                    <td class="px-3 py-2">
                      <div class="flex items-center gap-1">
                        <input type="number" [ngModel]="marginThreshold1()" (ngModelChange)="marginThreshold1.set($event)"
                               min="1" max="99" class="w-14 px-2 py-1 bg-white rounded border border-red-200 text-center font-bold text-red-700 text-sm outline-none focus:ring-1 focus:ring-red-400">
                        <span class="text-red-600 font-bold">%</span>
                      </div>
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-red-700">{{ formatCurrency(calculateRequiredRevenue(calculateTotalCost(currentItem), marginThreshold1())) }}</td>
                  </tr>
                  <tr class="bg-amber-50">
                    <td class="px-3 py-2">
                      <div class="flex items-center gap-1">
                        <input type="number" [ngModel]="marginThreshold2()" (ngModelChange)="marginThreshold2.set($event)"
                               min="1" max="99" class="w-14 px-2 py-1 bg-white rounded border border-amber-200 text-center font-bold text-amber-700 text-sm outline-none focus:ring-1 focus:ring-amber-400">
                        <span class="text-amber-600 font-bold">%</span>
                      </div>
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-amber-700">{{ formatCurrency(calculateRequiredRevenue(calculateTotalCost(currentItem), marginThreshold2())) }}</td>
                  </tr>
                  <tr class="bg-emerald-50">
                    <td class="px-3 py-2">
                      <div class="flex items-center gap-1">
                        <input type="number" [ngModel]="marginThreshold3()" (ngModelChange)="marginThreshold3.set($event)"
                               min="1" max="99" class="w-14 px-2 py-1 bg-white rounded border border-emerald-200 text-center font-bold text-emerald-700 text-sm outline-none focus:ring-1 focus:ring-emerald-400">
                        <span class="text-emerald-600 font-bold">%</span>
                        <span class="material-icons text-emerald-600 text-xs ml-1">check_circle</span>
                      </div>
                    </td>
                    <td class="px-3 py-2 text-right font-bold text-emerald-700">{{ formatCurrency(calculateRequiredRevenue(calculateTotalCost(currentItem), marginThreshold3())) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <p class="mt-3 text-[10px] text-slate-400 text-center">
              Formula: Total Cost ÷ (1 - Margin%)
            </p>
          </div>
        </div>
      </div>

      <!-- QUICK TIPS -->
      <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-2xl p-5 border border-blue-100">
        <h4 class="font-bold text-blue-800 flex items-center gap-2 mb-3">
          <span class="material-icons text-lg">tips_and_updates</span>
          Quick Tips
        </h4>
        <ul class="space-y-2 text-sm text-blue-700">
          <li class="flex items-start gap-2">
            <span class="material-icons text-xs mt-1 text-blue-400">check_circle</span>
            Keep profit margin above 30% for auto-approval
          </li>
          <li class="flex items-start gap-2">
            <span class="material-icons text-xs mt-1 text-blue-400">check_circle</span>
            Add items for accurate quotation generation
          </li>
          <li class="flex items-start gap-2">
            <span class="material-icons text-xs mt-1 text-blue-400">check_circle</span>
            Actual Revenue unlocks when status is "Completed"
          </li>
          <li class="flex items-start gap-2">
            <span class="material-icons text-xs mt-1 text-blue-400">check_circle</span>
            Use "Print Quotation" to export PDF
          </li>
        </ul>
      </div>

    </div>

  </div>

</div>

<!-- ==================== DELETE MODAL ==================== -->
<div *ngIf="showDeleteModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-md rounded-2xl p-6 shadow-2xl animate-fade-in">
    <div class="flex items-center gap-4 mb-6">
      <div class="w-12 h-12 bg-red-100 rounded-xl flex items-center justify-center">
        <span class="material-icons text-red-600 text-2xl">delete_forever</span>
      </div>
      <div>
        <h3 class="text-xl font-black text-slate-800">Delete Booking Order</h3>
        <p class="text-slate-500 text-sm">This action cannot be undone</p>
      </div>
    </div>
    <p class="text-slate-600 mb-6">
      Are you sure you want to delete <strong class="text-slate-800">{{ revenueToDelete?.campaign_name || revenueToDelete?.bo_name }}</strong>?
    </p>
    <div class="flex flex-col-reverse sm:flex-row gap-3">
      <button (click)="showDeleteModal = false"
              class="flex-1 px-4 py-3 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-all">
        Cancel
      </button>
      <button (click)="deleteRevenue()"
              class="flex-1 px-4 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-all">
        Delete
      </button>
    </div>
  </div>
</div>

<!-- ==================== APPROVAL MODAL ==================== -->
<div *ngIf="showApprovalModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
  <div class="bg-white w-full max-w-lg rounded-2xl p-6 shadow-2xl animate-fade-in">
    <div class="flex items-center gap-4 mb-6">
      <div class="w-12 h-12 bg-emerald-100 rounded-xl flex items-center justify-center">
        <span class="material-icons text-emerald-600 text-2xl">check_circle</span>
      </div>
      <div>
        <h3 class="text-xl font-black text-slate-800">Review Booking Order</h3>
        <p class="text-slate-500 text-sm">{{ revenueToApprove?.campaign_name }}</p>
      </div>
    </div>

    <!-- Profit Margin Warning -->
    <div *ngIf="revenueToApprove && isProfitMarginLow(revenueToApprove)"
         class="mb-4 p-4 border rounded-xl flex items-start gap-3"
         [class.bg-red-50]="calculateProfitMargin(revenueToApprove!) < 25"
         [class.border-red-200]="calculateProfitMargin(revenueToApprove!) < 25"
         [class.bg-amber-50]="calculateProfitMargin(revenueToApprove!) >= 25"
         [class.border-amber-200]="calculateProfitMargin(revenueToApprove!) >= 25">
      <span class="material-icons text-xl"
            [class.text-red-600]="calculateProfitMargin(revenueToApprove!) < 25"
            [class.text-amber-600]="calculateProfitMargin(revenueToApprove!) >= 25">warning</span>
      <div>
        <p class="font-bold"
           [class.text-red-800]="calculateProfitMargin(revenueToApprove!) < 25"
           [class.text-amber-800]="calculateProfitMargin(revenueToApprove!) >= 25">
          {{ calculateProfitMargin(revenueToApprove!) < 25 ? 'Critical: Low Profit Margin' : 'Warning: Below Target Margin' }}
        </p>
        <p class="text-sm"
           [class.text-red-700]="calculateProfitMargin(revenueToApprove!) < 25"
           [class.text-amber-700]="calculateProfitMargin(revenueToApprove!) >= 25">
          Profit margin is <strong>{{ calculateProfitMargin(revenueToApprove!) | number:'1.1-1' }}%</strong>
        </p>
      </div>
    </div>

    <div class="mb-6">
      <label class="block text-[10px] font-black text-slate-500 uppercase tracking-wider mb-2">Approval Notes (Optional)</label>
      <textarea [(ngModel)]="approvalNotes" rows="3"
                placeholder="Add any notes for this decision..."
                class="w-full px-4 py-3 bg-slate-50 rounded-xl border-0 font-medium text-slate-700 focus:ring-2 focus:ring-emerald-400 outline-none resize-none"></textarea>
    </div>

    <div class="flex flex-col-reverse sm:flex-row gap-3">
      <button (click)="showApprovalModal = false"
              class="flex-1 px-4 py-3 bg-slate-100 text-slate-700 rounded-xl font-bold hover:bg-slate-200 transition-all">
        Cancel
      </button>
      <button (click)="rejectRevenue()"
              class="flex-1 px-4 py-3 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700 transition-all flex items-center justify-center gap-2">
        <span class="material-icons text-lg">cancel</span>
        Reject
      </button>
      <button (click)="approveRevenue()"
              class="flex-1 px-4 py-3 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 transition-all flex items-center justify-center gap-2">
        <span class="material-icons text-lg">check</span>
        Approve
      </button>
    </div>
  </div>
</div>
